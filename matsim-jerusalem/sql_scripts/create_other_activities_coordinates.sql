drop table if exists trips_final;create table if not exists trips_final ASSELECT *FROM  (SELECT *,          rank() OVER (PARTITION BY hhid,                                    pnum,                                    persontripnum                       ORDER BY key1, random()) rank   FROM     (SELECT hhid,             pnum,             persontripnum,             origtaz,			 desttaz,             origpurp,			 destpurp,			 finaldepartminute,			 modecode      FROM trips) trips_mini   LEFT JOIN     (SELECT i.taz,             b.value1,             b.key1,             st_x((st_dump(p.geometry)).geom),             st_y((st_dump(p.geometry)).geom)      FROM poi_bldg p      LEFT JOIN        (SELECT *         FROM           (SELECT usg_group,                   usg_code,                   unnest(array['purp_1', 'purp_2', 'purp_3', 'purp_4', 'purp_5', 'purp_6', 'purp_7', 'purp_8']) AS key1,                   unnest(array[purp_1, purp_2, purp_3, purp_4, purp_5, purp_6, purp_7, purp_8]) AS value1            FROM bental_jtmt_code_conversion) q         WHERE value1 IS NOT NULL) b ON p.usg_code = b.usg_code      AND p.usg_group = b.usg_group      JOIN inner_taz i ON st_intersects(i.geometry, p.geometry)) taz_activities ON trips_mini.origtaz = taz_activities.taz   AND trips_mini.origpurp = taz_activities.value1) without_rankWHERE rank = 1ORDER BY hhid,         pnum,         persontripnum;CREATE INDEX idx_hhid_tf ON trips_final(hhid);		 